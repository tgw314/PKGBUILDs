# Maintainer : Koki Tagawa <me@k0k1.dev>
# Contributor : Zak BlueSwordM <neutronpcxt@gmail.com>
#
# Modified PKGBUILD using juliobbv-p/svt-av1-hdr fork.
# Builds libsvtav1 as a shared library for ffmpeg and SvtAv1EncApp as a static executable.
# Optimized with Clang, -O3, and ThinLTO.

pkgname=svt-av1-hdr-optimized-git
_pkgname=svt-av1-hdr
pkgver=3.1.0.r4486.gbd24e160
pkgrel=1
pkgdesc='SVT-AV1 Encoder with perceptual enhancements (shared lib + static app), optimized with Clang + O3 + ThinLTO'
arch=('x86_64')
url='https://github.com/juliobbv-p/svt-av1-hdr'
license=('BSD-3-Clause-Clear' 'custom: Alliance for Open Media Patent License 1.0')
depends=('glibc')
makedepends=('git' 'cmake' 'yasm' 'clang' 'mold' 'llvm')
provides=('svt-av1' 'svt-av1-git')
conflicts=('svt-av1' 'svt-av1-git' 'svt-av1-hdr-git')
source=("git+https://github.com/juliobbv-p/${_pkgname}.git")
sha256sums=('SKIP')

pkgver() {
  cd "${srcdir}/${_pkgname}"
  printf "%s.r%s.g%s" \
    "$(grep -m 1 'project(svt-av1 VERSION' CMakeLists.txt | sed -n 's/.*VERSION \([0-9.]*\).*/\1/p')" \
    "$(git rev-list --count HEAD)" \
    "$(git rev-parse --short HEAD)"
}

build() {
  # Common compiler and linker flags for Clang with optimizations
  local _cflags="${CFLAGS} -O3 -ffast-math -flto=thin -ffunction-sections -fdata-sections -fomit-frame-pointer -Wp,-D_FORTIFY_SOURCE=2"
  local _ldflags="${LDFLAGS} -flto=thin -fuse-ld=mold -Wl,--gc-sections -Wl,--as-needed -Wl,--icf=all"
  local _cmake_common_args=(
    -DCMAKE_INSTALL_PREFIX=/usr
    -DCMAKE_BUILD_TYPE=Release
    -DNATIVE=ON
    -DSVT_AV1_LTO=OFF
    -DCMAKE_C_COMPILER=clang
    -DCMAKE_CXX_COMPILER=clang++
    -DCMAKE_C_FLAGS="${_cflags}"
    -DCMAKE_CXX_FLAGS="${_cflags}"
    -DCMAKE_EXE_LINKER_FLAGS="${_ldflags}"
    -DCMAKE_SHARED_LINKER_FLAGS="${_ldflags}"
    -DCMAKE_MODULE_LINKER_FLAGS="${_ldflags}"
  )

  # --- Stage 1: Build Shared Library (for ffmpeg) ---
  cd "${srcdir}/${_pkgname}"
  cmake -B build-shared -S . \
    -DBUILD_SHARED_LIBS=ON \
    "${_cmake_common_args[@]}"
  make -C build-shared

  # --- Stage 2: Build Static Executable (SvtAv1EncApp) ---
  cmake -B build-static -S . \
    -DBUILD_SHARED_LIBS=OFF \
    "${_cmake_common_args[@]}"
  make -C build-static
}

package() {
  # Installs the shared library AND the static SvtAv1EncApp, which has already
  # replaced the dynamic version in the build output directory.
  make -C "${srcdir}/${_pkgname}/build-shared" DESTDIR="${pkgdir}" install

  # Install license files
  install -Dm644 "${_pkgname}"/{LICENSE,PATENTS}.md -t "${pkgdir}/usr/share/licenses/${pkgname}"
}
