# Maintainer: Josh Holmer <jholmer.in@gmail.com>

pkgname=xav-static-notq-git
pkgver=r112.a27f172
pkgrel=17
pkgdesc='The Most Efficient Chunked Video Encoding Framework (static build without TQ)'
arch=('x86_64')
url='https://github.com/emrakyz/xav'
license=('MIT')
makedepends=('git' 'cargo' 'nasm' 'clang' 'llvm' 'meson' 'ninja' 'autoconf' 'automake' 'libtool' 'cmake')
depends=('svt-av1' 'mkvtoolnix-cli')
optdepends=('gpac: for VVC muxing and concatenation'
            'opus-tools: for audio encoding')
provides=('xav' 'xav-git')
conflicts=('xav' 'xav-git' 'xav-dynamic-tq-git' 'xav-dynamic-notq-git' 'xav-static-tq-git')
source=("xav::git+https://github.com/emrakyz/xav.git"
        "zlib::git+https://github.com/madler/zlib.git"
        "dav1d::git+https://code.videolan.org/videolan/dav1d.git"
        "ffmpeg::git+https://github.com/FFmpeg/FFmpeg.git"
        "ffms2::git+https://github.com/FFMS/ffms2.git"
        "llvm-project-19.1.7.src.tar.xz::https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.7/llvm-project-19.1.7.src.tar.xz")
sha256sums=('SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP')

# Build configuration
_llvm_ver=19.1.7

pkgver() {
    cd "xav"
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
    # Configure cargo for static build without TQ
    cd "${srcdir}/xav"
    cp -f .cargo/config.toml.static_notq .cargo/config.toml
}

build() {
    export BUILD_DIR="${srcdir}"
    
    # --- LLVM Toolchain Setup ---
    export CC="clang"
    export CXX="clang++"
    export LD="ld.lld"
    export AR="llvm-ar"
    export NM="llvm-nm"
    export RANLIB="llvm-ranlib"
    export STRIP="llvm-strip"
    export OBJCOPY="llvm-objcopy"
    export OBJDUMP="llvm-objdump"
    
    # --- Flags Setup ---
    # Reset Arch Linux default flags
    unset CFLAGS CXXFLAGS LDFLAGS
    
    # Common optimization flags (matching upstream build.sh)
    # Note: -no-pie is NOT included here to avoid "unused argument" warnings during compilation checks
    local _common_flags="-O3 -ffast-math -march=native -mtune=native -flto=thin -pipe \
        -fno-math-errno -fomit-frame-pointer -fno-semantic-interposition \
        -fno-stack-protector -fno-stack-clash-protection -fno-sanitize=all \
        -fno-dwarf2-cfi-asm -fstrict-aliasing -fstrict-overflow \
        -fno-zero-initialized-in-bss -static -fno-pic -fno-pie"
    
    export COMMON_FLAGS="${_common_flags}"
    export CFLAGS="${COMMON_FLAGS}"
    export CXXFLAGS="${COMMON_FLAGS} -stdlib=libstdc++"
    
    # Linker flags
    # -no-pie: Required for static linking with -fno-pic objects on Arch
    # -unwindlib=none: We link our own static libunwind manually
    # Note: -lpthread -latomic removed as requested for testing
    export LDFLAGS="-fuse-ld=lld -rtlib=compiler-rt -unwindlib=none \
        -Wl,-O3 -Wl,--lto-O3 -Wl,--as-needed -Wl,-z,norelro -Wl,--build-id=none \
        -Wl,--relax -Wl,-z,noseparate-code -Wl,--strip-all -Wl,--no-eh-frame-hdr \
        -Wl,-znow -Wl,--gc-sections -Wl,--discard-all -Wl,--icf=all \
        -static -fno-pic -fno-pie -no-pie \
        -L${BUILD_DIR}/libunwind/install/lib -lunwind"
    
    # --- Build llvm-libunwind ---
    msg2 "Building llvm-libunwind..."
    cd "${BUILD_DIR}/llvm-project-${_llvm_ver}.src"
    
    cmake -S runtimes -B build -G Ninja \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX="${BUILD_DIR}/libunwind/install" \
        -DCMAKE_C_COMPILER="${CC}" \
        -DCMAKE_CXX_COMPILER="${CXX}" \
        -DLLVM_ENABLE_RUNTIMES="libunwind" \
        -DLIBUNWIND_ENABLE_SHARED=OFF \
        -DLIBUNWIND_ENABLE_STATIC=ON \
        -DLIBUNWIND_INSTALL_HEADERS=ON \
        -DCMAKE_C_FLAGS="-O3 -fno-pic -fno-pie -fno-stack-protector" \
        -DCMAKE_CXX_FLAGS="-O3 -fno-pic -fno-pie -fno-stack-protector"
    
    ninja -C build
    ninja -C build install
    
    # Update library paths for subsequent builds
    export LIBRARY_PATH="${BUILD_DIR}/libunwind/install/lib:${LIBRARY_PATH:-}"
    export LD_LIBRARY_PATH="${BUILD_DIR}/libunwind/install/lib:${LD_LIBRARY_PATH:-}"
    
    # --- Build zlib ---
    msg2 "Building zlib..."
    cd "${BUILD_DIR}/zlib"
    ./configure --static --prefix="${BUILD_DIR}/zlib/install"
    make -j$(nproc) libz.a
    make install
    
    # --- Build dav1d ---
    msg2 "Building dav1d..."
    cd "${BUILD_DIR}/dav1d"
    # Note: LDFLAGS are passed via environment
    meson setup build --default-library=static \
        --buildtype=release \
        -Denable_tools=false \
        -Denable_examples=false \
        -Dbitdepths=8,16 \
        -Denable_asm=true
    ninja -C build
    
    # Setup dav1d pkg-config manually (upstream build.sh method)
    mkdir -p "${BUILD_DIR}/dav1d/lib/pkgconfig"
    sed "s|prefix=/usr/local|prefix=${BUILD_DIR}/dav1d|g" \
        "${BUILD_DIR}/dav1d/build/meson-private/dav1d.pc" | \
        sed "s|includedir=\${prefix}/include|includedir=\${prefix}/include|g" | \
        sed "s|libdir=\${prefix}/lib64|libdir=\${prefix}/build/src|g" | \
        sed "s|libdir=\${prefix}/lib|libdir=\${prefix}/build/src|g" \
        > "${BUILD_DIR}/dav1d/lib/pkgconfig/dav1d.pc"
    
    # --- Build FFmpeg ---
    msg2 "Building FFmpeg..."
    export PKG_CONFIG_PATH="${BUILD_DIR}/dav1d/lib/pkgconfig:${BUILD_DIR}/ffmpeg/install/lib/pkgconfig"
    
    cd "${BUILD_DIR}/ffmpeg"
    ./configure \
        --cc="${CC}" --cxx="${CXX}" --ar="${AR}" --ranlib="${RANLIB}" --strip="${STRIP}" \
        --extra-cflags="${CFLAGS}" --extra-cxxflags="${CXXFLAGS}" --extra-ldflags="${LDFLAGS}" \
        --disable-shared --enable-static --pkg-config-flags="--static" \
        --disable-programs --disable-doc --disable-htmlpages --disable-manpages --disable-podpages --disable-txtpages \
        --disable-network --disable-autodetect --disable-all --disable-everything \
        --enable-avcodec --enable-avformat --enable-avutil --enable-swscale --enable-swresample \
        --enable-protocol=file \
        --enable-demuxer=matroska,mov,mpegts,mpegps,flv,avi,ivf,yuv4mpegpipe,h264,hevc,vvc \
        --enable-decoder=rawvideo,h264,hevc,mpeg2video,mpeg1video,mpeg4,av1,libdav1d,vp9,vc1,vvc \
        --enable-libdav1d \
        --enable-parser=h264,hevc,mpeg4video,mpegvideo,av1,vp9,vvc,vc1
    
    make -j$(nproc)
    make install DESTDIR="${BUILD_DIR}/ffmpeg/install" prefix=""
    
    # --- Build ffms2 ---
    msg2 "Building ffms2..."
    cd "${BUILD_DIR}/ffms2"
    mkdir -p src/config
    autoreconf -fiv
    
    PKG_CONFIG_PATH="${BUILD_DIR}/ffmpeg/install/lib/pkgconfig:${BUILD_DIR}/zlib/install/lib/pkgconfig" \
        CC="${CC}" CXX="${CXX}" AR="${AR}" RANLIB="${RANLIB}" \
        CFLAGS="${CFLAGS} -I${BUILD_DIR}/ffmpeg/install/include -I${BUILD_DIR}/zlib/install/include" \
        CXXFLAGS="${CXXFLAGS} -I${BUILD_DIR}/ffmpeg/install/include -I${BUILD_DIR}/zlib/install/include" \
        LDFLAGS="${LDFLAGS} -L${BUILD_DIR}/ffmpeg/install/lib -L${BUILD_DIR}/zlib/install/lib" \
        LIBS="-lpthread -lm -lz" \
        ./configure \
        --enable-static --disable-shared \
        --with-zlib="${BUILD_DIR}/zlib/install"
    
    make -j$(nproc)
    
    # --- Build XAV ---
    msg2 "Building XAV..."
    cd "${srcdir}/xav"
    
    # Setup build.rs expected structure
    export HOME="${srcdir}"
    mkdir -p "${srcdir}/.local/src"
    ln -sf "${BUILD_DIR}/ffmpeg" "${srcdir}/.local/src/FFmpeg"
    ln -sf "${BUILD_DIR}/dav1d" "${srcdir}/.local/src/dav1d"
    ln -sf "${BUILD_DIR}/zlib" "${srcdir}/.local/src/zlib"
    
    # Env for static linking
    export PKG_CONFIG_ALL_STATIC=1
    export FFMPEG_DIR="${BUILD_DIR}/ffmpeg/install"
    export FFMS_INCLUDE_DIR="${BUILD_DIR}/ffms2/include"
    export FFMS_LIB_DIR="${BUILD_DIR}/ffms2/src/core/.libs"
    export PKG_CONFIG_PATH="${BUILD_DIR}/ffmpeg/install/lib/pkgconfig:${PKG_CONFIG_PATH}"
    
    # Force Rust to use -no-pie (fix for Arch static linking)
    export RUSTFLAGS="-C link-arg=-no-pie"
    
    cargo build --release --features static
}

package() {
    cd "${srcdir}/xav"
    install -Dm755 "target/${CARCH}-unknown-linux-gnu/release/xav" -t "${pkgdir}/usr/bin"
    install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}