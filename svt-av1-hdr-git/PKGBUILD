# Maintainer : Koki Tagawa <me@k0k1.dev>
# Contributor : Zak BlueSwordM <neutronpcxt@gmail.com>
#
# Modified PKGBUILD using juliobbv-p/svt-av1-hdr fork based on svt-av1-psy-git

pkgname=svt-av1-hdr-git
_pkgname=svt-av1-hdr
pkgver=3.1.0.r4480.g8d67acb5
pkgrel=1
pkgdesc='SVT-AV1 Encoder with perceptual enhancements for psychovisually optimal SDR and HDR AV1 encoding'
arch=('x86_64')
url='https://github.com/juliobbv-p/svt-av1-hdr'
license=('BSD-3-Clause-Clear' 'custom: Alliance for Open Media Patent License 1.0')
depends=('glibc')
makedepends=('git' 'cmake' 'yasm')
provides=('svt-av1' 'svt-av1-git')
conflicts=('svt-av1' 'svt-av1-git')
source=("git+https://github.com/juliobbv-p/${_pkgname}.git")
sha256sums=('SKIP')

pkgver() {
  cd "$_pkgname"
  
  # Extract version from CMakeLists.txt (e.g., 3.1.0)
  local _ver
  _ver=$(grep -m 1 "project(svt-av1 VERSION" CMakeLists.txt | sed -n 's/.*VERSION \([0-9.]*\).*/\1/p')
  
  # Get the total number of commits
  local _rev
  _rev=$(git rev-list --count HEAD)
  
  # Get the short hash of the latest commit
  local _hash
  _hash=$(git rev-parse --short HEAD)
  
  # Combine them into a version string like 3.1.0.r123.gabcdef
  printf "%s.r%s.g%s" "${_ver:-0.0.0}" "${_rev:-0}" "${_hash:-unknown}"
}

build() {
  export LDFLAGS+=' -Wl,-z,noexecstack'
  
  # Build the project using cmake
  cmake -B build -S "$_pkgname" \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DENABLE_AVX512=ON \
    -DNATIVE=ON \
    -DBUILD_SHARED_LIBS=ON \
    -DSVT_AV1_LTO=ON
    
  make -C build
}

package() {
  # Install the built files into the package directory
  make -C build DESTDIR="$pkgdir" install
  
  # Install license files
  install -D -m644 "${_pkgname}"/{LICENSE,PATENTS}.md -t "${pkgdir}/usr/share/licenses/${pkgname}"
}
